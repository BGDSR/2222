const App=(()=>{const state={products:[],viewed:[],combos:{"royal-oud":["amber-silk","musk-sultan"],"desert-rose":["oud-mystique","white-musk"],"amber-silk":["rose-dune","musk-sultan"]}};function qs(s,el=document){return el.querySelector(s)}function qsa(s,el=document){return [...el.querySelectorAll(s)]}function fmtPrice(v){return new Intl.NumberFormat('ru-RU',{style:'currency',currency:'RUB',maximumFractionDigits:0}).format(v)}function save(k,v){localStorage.setItem(k,JSON.stringify(v))}function load(k,d){try{const v=JSON.parse(localStorage.getItem(k));return v??d}catch{return d}}function trackView(slug){let v=load('viewedProducts',[]);v=[slug,...v.filter(s=>s!==slug)].slice(0,16);save('viewedProducts',v);state.viewed=v}async function fetchProducts(){try{const res=await fetch('/assets/products.json',{cache:'no-store'});state.products=await res.json()}catch(e){console.error('failed to load products',e)}}function renderStars(r){const full=Math.round(r);return '★★★★★'.split('').map((c,i)=>`<span style="opacity:${i<full?1:.25}">★</span>`).join('')}function productCard(p,opts={compact:false}){const price=fmtPrice(p.price),old=p.oldPrice?`<span class="old">${fmtPrice(p.oldPrice)}</span>`:'';const badge=p.badge?`<span class="pill">${p.badge}</span>`:'';const action=opts.compact?`<button class="btn btn-outline" data-action="view" data-slug="${p.slug}">Подробнее</button>`:`<button class="btn btn-primary" data-action="consult" data-slug="${p.slug}">Запросить опт</button><button class="btn btn-outline" data-action="buy" data-slug="${p.slug}">Купить</button>`;return `<article id="${p.slug}" class="product-card" data-slug="${p.slug}" data-family="${p.family}" data-gender="${p.gender}" data-concentration="${p.concentration}"><div class="product-image"><img loading="lazy" src="${p.image}" alt="${p.name} — ${p.brand}">${badge}</div><div class="product-info"><div class="product-meta"><span>${p.brand}</span><span>${p.volumeOptions.join(', ')}</span></div><h3 class="product-title">${p.name}</h3><div class="rating" aria-label="Рейтинг ${p.rating} из 5">${renderStars(p.rating)}<span class="muted">(${p.reviewsCount})</span></div><div class="price"><b>${price}</b>${old}</div><div class="chips"><span class="chip">${p.family}</span><span class="chip">${p.concentration}</span></div><div class="card-actions">${action}</div></div></article>`}function mountCatalog(rootSel){const root=qs(rootSel);if(!root)return;root.innerHTML='<div class="grid grid-4" id="catalog-grid"></div>';const grid=qs('#catalog-grid',root);grid.innerHTML=state.products.map(p=>productCard(p)).join('');grid.addEventListener('click',e=>{const btn=e.target.closest('button');if(!btn)return;const slug=btn.dataset.slug;const p=state.products.find(x=>x.slug===slug);if(!p)return;trackView(slug);if(btn.dataset.action==='consult'){openConsultModal(p)}if(btn.dataset.action==='buy'){openWhatsApp(p)}if(btn.dataset.action==='view'){/* no-op for compact */}})}function openConsultModal(product){const modal=qs('#consult-modal');if(!modal)return;qs('#consult-product').value=product?`${product.brand} ${product.name}`:'';modal.classList.add('active')}function closeConsultModal(){qs('#consult-modal')?.classList.remove('active')}function openWhatsApp(product){const phone=qs('meta[name="whatsapp"]').content||'';const text=encodeURIComponent(`Здравствуйте! Интересует аромат: ${product.brand} ${product.name}. Рассчитайте, пожалуйста, оптовое предложение.`);const url=`https://wa.me/${phone}?text=${text}`;window.open(url,'_blank')}function buildCarousel(sel,items){const root=qs(sel);if(!root)return;const wrap=document.createElement('div');wrap.innerHTML=`<div class="carousel-controls"><button class="icon-btn" data-dir="-1" aria-label="Назад">‹</button><button class="icon-btn" data-dir="1" aria-label="Вперёд">›</button></div><div class="carousel" id="carousel-list"></div>`;root.appendChild(wrap);const list=qs('#carousel-list',wrap);list.innerHTML=items.map(p=>productCard(p,{compact:true})).join('');wrap.addEventListener('click',e=>{const b=e.target.closest('button[data-dir]');if(!b)return;list.scrollBy({left:parseInt(b.dataset.dir,10)*list.clientWidth*.9,behavior:'smooth'})});list.addEventListener('click',e=>{const btn=e.target.closest('button');if(!btn)return;const p=state.products.find(x=>x.slug===btn.dataset.slug);if(!p)return;trackView(p.slug);if(btn.dataset.action==='consult')openConsultModal(p)})}function mountRecommended(){const root=qs('#recommended');if(!root||!state.products.length)return;const recent=state.viewed.filter(slug=>state.products.some(p=>p.slug===slug));const picks=(recent.length?recent.map(slug=>state.products.find(p=>p.slug===slug)):state.products.slice().sort(()=>Math.random()-.5).slice(0,6)).map(p=>p);root.innerHTML='<div class="grid grid-3" id="rec-grid"></div>';qs('#rec-grid',root).innerHTML=picks.map(p=>productCard(p,{compact:true})).join('')}function mountCombos(){const root=qs('#combos');if(!root||!state.products.length)return;const top=state.viewed[0]||state.products[0]?.slug;if(!top)return;const ids=state.combos[top]||state.products.slice(0,3).map(p=>p.slug);const items=ids.map(slug=>state.products.find(p=>p.slug===slug)).filter(Boolean);buildCarousel('#combos',items)}function setupFilters(){const container=qs('#catalog-filters');if(!container)return;const families=[...new Set(state.products.map(p=>p.family))];const genders=[...new Set(state.products.map(p=>p.gender))];const concs=[...new Set(state.products.map(p=>p.concentration))];function chip(val,group){return `<button class="filter-chip" data-group="${group}" data-val="${val}">${val}</button>`}container.innerHTML=`<div class="filters">${families.map(v=>chip(v,'family')).join('')}${genders.map(v=>chip(v,'gender')).join('')}${concs.map(v=>chip(v,'concentration')).join('')}</div>`;container.addEventListener('click',e=>{const b=e.target.closest('.filter-chip');if(!b)return;b.classList.toggle('active');applyFilters()})}function applyFilters(){const active=Array.from(document.querySelectorAll('.filter-chip.active')).map(el=>({g:el.dataset.group,v:el.dataset.val}));const cards=qsa('.product-card');cards.forEach(card=>{const show=active.every(f=>card.dataset[f.g]===f.v);card.style.display=show?'block':'none'})}function setupExitIntent(){const modal=qs('#exit-modal');if(!modal)return;let shown=load('exitShown',false);function show(){if(shown)return;modal.classList.add('active');shown=true;save('exitShown',true)}document.addEventListener('mouseleave',e=>{if(e.clientY<=0)show()},{passive:true});qsa('[data-close="exit"]').forEach(el=>el.addEventListener('click',()=>modal.classList.remove('active')));qs('#exit-form')?.addEventListener('submit',e=>{e.preventDefault();const email=qs('#exit-email').value.trim();if(email){save('leadEmail',email);toast('Каталог будет отправлен на вашу почту.');modal.classList.remove('active')}})}function setupConsultForm(){const modal=qs('#consult-modal');if(!modal)return;qsa('[data-close="consult"]').forEach(el=>el.addEventListener('click',closeConsultModal));qs('#consult-form')?.addEventListener('submit',e=>{e.preventDefault();const data=Object.fromEntries(new FormData(e.target));save('consultLead',data);toast('Заявка отправлена. Мы свяжемся с вами.');closeConsultModal()})}function toast(msg){const t=qs('#toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500)}function revealOnScroll(){const items=qsa('.reveal');const io=new IntersectionObserver(entries=>{entries.forEach(en=>{if(en.isIntersecting){en.target.classList.add('in');io.unobserve(en.target)}})},{threshold:.15});items.forEach(el=>io.observe(el))}function setupStickyCTA(){qs('#cta-btn')?.addEventListener('click',()=>{qs('#consult-modal')?.classList.add('active')})}function setupSearch(){const apply=()=>{const url=new URL(location.href);const q=(url.searchParams.get('q')||'').trim().toLowerCase();const cards=qsa('.product-card');if(!q){cards.forEach(c=>c.style.display='block');return}cards.forEach(c=>{const title=c.querySelector('.product-title')?.textContent?.toLowerCase()||'';const brand=c.querySelector('.product-meta span')?.textContent?.toLowerCase()||'';c.style.display=(title.includes(q)||brand.includes(q))?'block':'none'})};window.addEventListener('popstate',apply);document.addEventListener('do-search',apply);apply()}function injectSchema(){const org={"@context":"https://schema.org","@type":"Organization","name":"Maison Al Qamar","url":location.origin,"logo":location.origin+"/assets/logo.svg","sameAs":["https://www.instagram.com/","https://t.me/"]};const site={"@context":"https://schema.org","@type":"WebSite","name":"Арабская парфюмерия оптом и в розницу","url":location.origin,"potentialAction":{"@type":"SearchAction","target":location.origin+"/catalog.html?q={search_term_string}","query-input":"required name=search_term_string"}};const s1=document.createElement('script');s1.type='application/ld+json';s1.textContent=JSON.stringify(org);document.head.appendChild(s1);const s2=document.createElement('script');s2.type='application/ld+json';s2.textContent=JSON.stringify(site);document.head.appendChild(s2)}async function init(){state.viewed=load('viewedProducts',[]);await fetchProducts();mountCatalog('#catalog');mountRecommended();mountCombos();setupFilters();setupExitIntent();setupConsultForm();setupStickyCTA();revealOnScroll();injectSchema();setupSearch()}return{init}})();document.addEventListener('DOMContentLoaded',App.init);